<div class="automata-app" [class.immersive]="isImmersive">
  <header
    #appHeader
    class="automata-header"
    [class.automata-header--mobile-fullscreen]="isMobileLayout && isMobileFullScreen"
  >
    <div class="automata-header__left" aria-label="AutomataJS">
      <img class="automata-logo" src="assets/automatajs.svg" alt="AutomataJS" />
    </div>
    <div class="automata-header__right">
      <button type="button" class="ghost-button" (click)="openAbout()">ABOUT</button>
    </div>
  </header>

  <main
    #shellMain
    class="automata-shell"
    [class.automata-shell--mobile]="isMobileLayout"
    [class.automata-shell--mobile-fullscreen]="isMobileLayout && isMobileFullScreen"
    [class.automata-shell--immersive]="effectiveImmersive"
  >
    <section #canvasSection class="automata-shell__canvas">
      <app-automata-canvas
        [isImmersive]="effectiveImmersive"
        [isMobileLayout]="isMobileLayout"
        [isMobileFullScreen]="isMobileFullScreen"
        [showIdleCountdown]="idleCountdownVisible"
        (enterImmersiveMode)="enterImmersive()"
        (requestMobileFullScreen)="onRequestMobileFullScreen()"
        (exitMobileFullScreen)="onExitMobileFullScreen()"
      ></app-automata-canvas>
      <div class="idle-countdown" *ngIf="idleCountdownVisible">
        Switching to immersive mode in {{ idleCountdownRemaining }}s
      </div>

      <div
        #transportBar
        class="transport-tray"
        [class.transport-tray--hidden]="isImmersive && !transportVisible"
        [class.transport-tray--collapsed]="isMobileLayout && mobileSettingsBarCollapsed"
      >
        <app-automata-transport-bar
          [status]="uiState.status"
          [speed]="simulationConfig.speed"
          [isMobileLayout]="isMobileLayout"
          [mobileCollapsed]="mobileSettingsBarCollapsed"
          (mouseenter)="onImmersiveTransportInteraction()"
          (focusin)="onImmersiveTransportInteraction()"
          (play)="onPlay()"
          (pause)="onPause()"
          (reset)="onReset()"
          (step)="onStep()"
          (speedChange)="onSpeedChange($event)"
          (settingsToggle)="onMobileSettingsToggle()"
          (collapseToggle)="onMobileSettingsCollapseToggle()"
        ></app-automata-transport-bar>
      </div>

      <ng-container *ngIf="shouldShowRuleOverlayDock">
        <div class="rule-dock" [class.rule-dock--immersive]="isImmersive">
          <button
            type="button"
            class="rule-dock__badge"
            (click)="toggleRuleOverlay()"
            [attr.aria-pressed]="isRuleOverlayExpanded ? 'true' : 'false'"
            aria-label="Toggle rule and visual controls"
          >
            <span class="rule-dock__badge-label">Rule</span>
            <span class="rule-dock__badge-name">{{ uiState.ruleName || 'Rule settings' }}</span>
          </button>
          <div class="rule-dock__panel" *ngIf="isRuleOverlayExpanded">
            <div class="rule-dock__panel-header">
              <div>
                <p class="rule-dock__panel-eyebrow">Rule &amp; look</p>
                <h4 class="rule-dock__panel-title">{{ uiState.ruleName || 'Current rule' }}</h4>
                <p class="rule-dock__panel-summary" *ngIf="uiState.ruleDescription">
                  {{ uiState.ruleDescription }}
                </p>
              </div>
              <button
                type="button"
                class="rule-dock__panel-close"
                aria-label="Collapse rule overlay"
                (click)="closeRuleOverlay()"
              >
                <mat-icon>{{ isImmersive ? 'close' : 'expand_more' }}</mat-icon>
              </button>
            </div>
            <div class="rule-dock__panel-body">
              <app-automata-control
                variant="quick-rule"
                [config]="simulationConfig"
                [status]="uiState.status"
                [uiState]="uiState"
                [autoImmersivePreference]="autoImmersivePreference"
                (configChange)="onConfigChange($event)"
                (statusChange)="onStatusChange($event)"
                (uiStateChange)="onUiStateChange($event)"
                (autoImmersivePreferenceChange)="onAutoImmersivePreferenceChange($event)"
              ></app-automata-control>
            </div>
          </div>
        </div>
      </ng-container>

      <div
        *ngIf="showAutoImmersiveOptIn"
        #autoImmersiveBanner
        class="auto-immersive-banner"
        role="dialog"
        aria-live="polite"
      >
        <div class="auto-immersive-banner__text">
          Immersive mode &mdash; go fullscreen automatically when you're idle?
        </div>
        <div class="auto-immersive-banner__actions">
          <button type="button" class="auto-immersive-banner__btn auto-immersive-banner__btn--primary" (click)="onAutoImmersiveOptIn(true)">
            Yes
          </button>
          <button type="button" class="auto-immersive-banner__btn" (click)="onAutoImmersiveOptIn(false)">
            Not now
          </button>
        </div>
      </div>

      <div class="canvas-frame-top" *ngIf="exitPillVisible">
        <button
          #exitPillButton
          class="canvas-mode-handle canvas-mode-handle--exit"
          type="button"
          aria-label="Exit immersive mode"
          (click)="exitImmersiveMode()"
          (mouseenter)="onExitPillHover($event, true)"
          (mouseleave)="onExitPillHover($event, false)"
          (focusin)="onExitPillHover($event, true)"
          (focusout)="onExitPillHover($event, false)"
        >
          <lucide-icon name="x" class="canvas-mode-handle__icon" size="16"></lucide-icon>
          <span class="canvas-mode-handle__label">Exit immersive mode</span>
        </button>
      </div>

      <button
        *ngIf="isImmersive"
        class="immersive-handle immersive-handle--right"
        type="button"
        aria-label="Show control panel"
        [attr.aria-pressed]="panelOpen ? 'true' : 'false'"
        (click)="toggleControls()"
        (mouseenter)="onImmersiveHandleHover($event, true, 'control')"
        (mouseleave)="onImmersiveHandleHover($event, false, 'control')"
        (focusin)="onImmersiveHandleHover($event, true, 'control')"
        (focusout)="onImmersiveHandleHover($event, false, 'control')"
      >
        <span class="immersive-handle__icon-stack" aria-hidden="true">
          <lucide-icon name="settings" size="16"></lucide-icon>
        </span>
      </button>

      <button
        #bottomHandle
        *ngIf="isImmersive && !transportVisible"
        class="immersive-handle immersive-handle--bottom"
        type="button"
        aria-label="Show transport controls"
        (click)="showTransport()"
        (mouseenter)="onImmersiveHandleHover($event, true, 'transport')"
        (mouseleave)="onImmersiveHandleHover($event, false, 'transport')"
        (focusin)="onImmersiveHandleHover($event, true, 'transport')"
        (focusout)="onImmersiveHandleHover($event, false, 'transport')"
      >
        <span class="immersive-handle__icon-row" aria-hidden="true">
          <lucide-icon name="play" size="16"></lucide-icon>
        </span>
      </button>
    </section>

    <aside
      #controlPanel
      class="automata-shell__panel"
      *ngIf="!isMobileLayout && panelOpen && !effectiveImmersive"
    >
      <div class="panel__header">
        <p class="panel__eyebrow">Control center</p>
      </div>
      <div class="panel__body">
        <app-automata-control
          [config]="simulationConfig"
          [status]="uiState.status"
          [uiState]="uiState"
          [autoImmersivePreference]="autoImmersivePreference"
          (configChange)="onConfigChange($event)"
          (statusChange)="onStatusChange($event)"
          (uiStateChange)="onUiStateChange($event)"
          (autoImmersivePreferenceChange)="onAutoImmersivePreferenceChange($event)"
        ></app-automata-control>
      </div>
    </aside>
    <div
      *ngIf="isMobileLayout"
      class="automata-shell__mobile-controls-backdrop"
      [class.automata-shell__mobile-controls-backdrop--open]="mobileControlsOpen"
      [attr.aria-hidden]="mobileControlsOpen ? 'false' : 'true'"
      (click)="closeMobileControlsOverlay()"
    >
      <div
        class="automata-shell__mobile-controls-panel"
        [class.automata-shell__mobile-controls-panel--open]="mobileControlsOpen"
        (click)="$event.stopPropagation()"
      >
        <div class="panel__header">
          <p class="panel__eyebrow">Settings</p>
        </div>
        <div class="panel__body">
          <app-automata-control
            variant="quick-rule"
            [config]="simulationConfig"
            [status]="uiState.status"
            [uiState]="uiState"
            [autoImmersivePreference]="autoImmersivePreference"
            (configChange)="onConfigChange($event)"
            (statusChange)="onStatusChange($event)"
            (uiStateChange)="onUiStateChange($event)"
            (autoImmersivePreferenceChange)="onAutoImmersivePreferenceChange($event)"
          ></app-automata-control>
        </div>
      </div>
    </div>
  </main>

  <div class="automata-shell__about" *ngIf="isAboutOpen">
    <div class="about-card" role="dialog" aria-modal="true" aria-label="About AutomataJS">
      <button type="button" class="about-card__close" (click)="closeAbout()">
        <mat-icon>close</mat-icon>
      </button>
      <h3>About AutomataJS</h3>
      <p>
        AutomataJS is a GPU-accelerated playground for iterating on cellular automata without touching GLSL. Every
        simulation runs inside shaders so you can pause, recolor, zoom, and resume at full speed.
      </p>
      <p>
        Responsive controls, touch-friendly sliders, and curated presets help you explore emergent behavior on desktop or
        mobile. Save palettes, tweak rules, and capture high-resolution stills as you experiment.
      </p>
      <a
        class="about-card__link"
        href="https://github.com/bisignam/automatajs"
        target="_blank"
        rel="noopener"
      >
        View project on GitHub
      </a>
    </div>
  </div>
</div>
