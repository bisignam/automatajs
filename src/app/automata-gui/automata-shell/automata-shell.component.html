<div class="automata-app" [class.immersive]="isImmersive">
  <header
    #appHeader
    class="automata-header"
    [class.automata-header--mobile-fullscreen]="isMobileLayout && isMobileFullScreen"
  >
    <div class="automata-header__left" aria-label="AutomataJS">
      <img class="automata-logo" src="assets/automatajs.svg" alt="AutomataJS" />
    </div>
    <div class="automata-header__right">
      <button type="button" class="ghost-button" (click)="openAbout()">ABOUT</button>
    </div>
  </header>

  <main
    #shellMain
    class="automata-shell"
    [class.automata-shell--mobile]="isMobileLayout"
    [class.automata-shell--mobile-fullscreen]="isMobileLayout && isMobileFullScreen"
    [class.automata-shell--immersive]="effectiveImmersive"
  >
    <section #canvasSection class="automata-shell__canvas">
      <app-automata-canvas
        [isImmersive]="effectiveImmersive"
        [isMobileLayout]="isMobileLayout"
        [isMobileFullScreen]="isMobileFullScreen"
        [showIdleCountdown]="idleCountdownVisible"
        (enterImmersiveMode)="enterImmersive()"
        (requestMobileFullScreen)="onRequestMobileFullScreen()"
        (exitMobileFullScreen)="onExitMobileFullScreen()"
      ></app-automata-canvas>
      <div class="mobile-rule-label" *ngIf="isMobileLayout && uiState.ruleName">
        {{ uiState.ruleName }}
      </div>

      <div class="idle-countdown" *ngIf="idleCountdownVisible">
        Switching to immersive mode in {{ idleCountdownRemaining }}s
      </div>

      <ng-container *ngIf="!isMobileLayout">
        <div
          #transportBar
          class="transport-tray"
          [class.transport-tray--hidden]="isImmersive && !transportVisible"
        >
          <app-automata-transport-bar
            [status]="uiState.status"
            [speed]="simulationConfig.speed"
            (mouseenter)="onImmersiveTransportInteraction()"
            (focusin)="onImmersiveTransportInteraction()"
            (play)="onPlay()"
            (pause)="onPause()"
            (reset)="onReset()"
            (step)="onStep()"
            (speedChange)="onSpeedChange($event)"
          ></app-automata-transport-bar>
        </div>
      </ng-container>

      <ng-container *ngIf="shouldShowRuleOverlayDock">
        <div class="rule-dock" [class.rule-dock--immersive]="isImmersive">
          <button
            type="button"
            class="rule-badge"
            (click)="toggleDesktopRuleOverlay()"
            [attr.aria-pressed]="isDesktopRuleOverlayExpanded ? 'true' : 'false'"
            aria-label="Toggle rule controls"
            [class.rule-badge--expanded]="isDesktopRuleOverlayExpanded"
            [class.rule-badge--collapsed]="!isDesktopRuleOverlayExpanded"
          >
            <span class="rule-badge__name">{{ uiState.ruleName }}</span>
            <lucide-icon
              name="chevron-down"
              class="rule-badge__chevron"
              [class.rule-badge__chevron--collapsed]="!isDesktopRuleOverlayExpanded"
              size="16"
            ></lucide-icon>
          </button>
          <div class="rule-dock__panel" *ngIf="isDesktopRuleOverlayExpanded">
            <div class="rule-dock__panel-body">
              <app-automata-control
                variant="quick-rule"
                [config]="simulationConfig"
                [status]="uiState.status"
                [uiState]="uiState"
                [autoImmersivePreference]="autoImmersivePreference"
                (configChange)="onConfigChange($event)"
                (statusChange)="onStatusChange($event)"
                (uiStateChange)="onUiStateChange($event)"
                (autoImmersivePreferenceChange)="onAutoImmersivePreferenceChange($event)"
              ></app-automata-control>
            </div>
          </div>
        </div>
      </ng-container>

      <div class="mobile-dock-shell" *ngIf="isMobileLayout">
        <div
          #mobileDock
          *ngIf="!mobileDockCollapsed || mobileDockAnimating"
          class="mobile-dock"
          [class.mobile-dock--collapsed]="mobileDockCollapsed"
        >
          <div class="mobile-dock__content">
            <button
              type="button"
              class="mobile-dock__rule"
              (click)="openMobileRulePicker()"
              aria-label="Change rule"
            >
              <lucide-icon name="sparkles" size="18"></lucide-icon>
            </button>

            <div class="mobile-dock__palette" *ngIf="mobilePaletteSwatches.length">
              <button
                type="button"
                class="mobile-dock__swatch"
                *ngFor="let swatch of mobilePaletteSwatches"
                [style.background-color]="swatch.color"
                (click)="openMobileColorPicker(swatch)"
                [attr.aria-label]="swatch.label + ' color'"
              ></button>
            </div>

            <button
              type="button"
              class="mobile-dock__cell"
              (click)="openMobileCellSizeOverlay()"
              aria-label="Adjust cell size"
            >
              <lucide-icon name="grid-3x3" size="20"></lucide-icon>
            </button>

            <div class="mobile-dock__separator" aria-hidden="true"></div>

            <div class="mobile-dock__transport">
              <button
                type="button"
                class="mobile-dock__icon-button mobile-dock__icon-button--danger"
                (click)="onClearGrid()"
                aria-label="Clear grid"
              >
                <lucide-icon name="trash-2"></lucide-icon>
              </button>
            </div>
          </div>
          <button
            type="button"
            class="mobile-dock__toggle"
            (click)="toggleMobileDockCollapsed()"
            aria-label="Collapse controls"
          >
            <lucide-icon name="chevron-right" size="14"></lucide-icon>
          </button>
        </div>
        <button
          type="button"
          class="mobile-dock-toggle"
          *ngIf="mobileDockCollapsed"
          (click)="toggleMobileDockCollapsed()"
          aria-label="Expand controls"
        >
          <lucide-icon name="chevron-left" size="16"></lucide-icon>
        </button>
      </div>

      <div
        *ngIf="showAutoImmersiveOptIn"
        #autoImmersiveBanner
        class="auto-immersive-banner"
        role="dialog"
        aria-live="polite"
      >
        <div class="auto-immersive-banner__text">
          Immersive mode &mdash; go fullscreen automatically when you're idle?
        </div>
        <div class="auto-immersive-banner__actions">
          <button type="button" class="auto-immersive-banner__btn auto-immersive-banner__btn--primary" (click)="onAutoImmersiveOptIn(true)">
            Yes
          </button>
          <button type="button" class="auto-immersive-banner__btn" (click)="onAutoImmersiveOptIn(false)">
            Not now
          </button>
        </div>
      </div>

      <div class="canvas-frame-top" *ngIf="exitPillVisible">
        <button
          #exitPillButton
          class="canvas-mode-handle canvas-mode-handle--exit"
          type="button"
          aria-label="Exit immersive mode"
          (click)="exitImmersiveMode()"
          (mouseenter)="onExitPillHover($event, true)"
          (mouseleave)="onExitPillHover($event, false)"
          (focusin)="onExitPillHover($event, true)"
          (focusout)="onExitPillHover($event, false)"
        >
          <lucide-icon name="x" class="canvas-mode-handle__icon" size="16"></lucide-icon>
          <span class="canvas-mode-handle__label">Exit immersive mode</span>
        </button>
      </div>

      <button
        *ngIf="isImmersive"
        class="immersive-handle immersive-handle--right"
        type="button"
        aria-label="Show control panel"
        [attr.aria-pressed]="panelOpen ? 'true' : 'false'"
        (click)="toggleControls()"
        (mouseenter)="onImmersiveHandleHover($event, true, 'control')"
        (mouseleave)="onImmersiveHandleHover($event, false, 'control')"
        (focusin)="onImmersiveHandleHover($event, true, 'control')"
        (focusout)="onImmersiveHandleHover($event, false, 'control')"
      >
        <span class="immersive-handle__icon-stack" aria-hidden="true">
          <lucide-icon name="settings" size="16"></lucide-icon>
        </span>
      </button>

      <button
        #bottomHandle
        *ngIf="isImmersive && !transportVisible"
        class="immersive-handle immersive-handle--bottom"
        type="button"
        aria-label="Show transport controls"
        (click)="showTransport()"
        (mouseenter)="onImmersiveHandleHover($event, true, 'transport')"
        (mouseleave)="onImmersiveHandleHover($event, false, 'transport')"
        (focusin)="onImmersiveHandleHover($event, true, 'transport')"
        (focusout)="onImmersiveHandleHover($event, false, 'transport')"
      >
        <span class="immersive-handle__icon-row" aria-hidden="true">
          <lucide-icon name="play" size="16"></lucide-icon>
        </span>
      </button>

      <div class="mobile-speed-strip" *ngIf="isMobileLayout">
        <button
          type="button"
          class="mobile-speed-strip__play"
          (click)="toggleMobilePlay()"
          [attr.aria-label]="uiState.status === 'running' ? 'Pause' : 'Play'"
        >
          <lucide-icon [name]="uiState.status === 'running' ? 'pause' : 'play'" size="18"></lucide-icon>
        </button>
        <div class="mobile-speed-strip__slider">
          <div class="mobile-speed-strip__label">
            <lucide-icon name="gauge" size="16"></lucide-icon>
            <span>Speed</span>
          </div>
          <input
            type="range"
            min="5"
            max="120"
            step="5"
            [value]="simulationConfig.speed"
            (input)="onMobileSpeedInput($event)"
            aria-label="Adjust playback speed"
          />
        </div>
        <span class="mobile-speed-strip__value">{{ simulationConfig.speed }} FPS</span>
      </div>
    </section>

    <ng-container *ngIf="!isMobileLayout && panelOpen && !effectiveImmersive; else controlBridgeFallback">
      <aside #controlPanel class="automata-shell__panel">
        <div class="panel__header">
          <p class="panel__eyebrow">Control center</p>
        </div>
        <div class="panel__body">
          <app-automata-control
            #controlBridge
            [config]="simulationConfig"
            [status]="uiState.status"
            [uiState]="uiState"
            [autoImmersivePreference]="autoImmersivePreference"
            (configChange)="onConfigChange($event)"
            (statusChange)="onStatusChange($event)"
            (uiStateChange)="onUiStateChange($event)"
            (autoImmersivePreferenceChange)="onAutoImmersivePreferenceChange($event)"
          ></app-automata-control>
        </div>
      </aside>
    </ng-container>
  </main>

  <ng-template #controlBridgeFallback>
    <div class="control-logic-bridge" aria-hidden="true">
      <app-automata-control
        #controlBridge
        [config]="simulationConfig"
        [status]="uiState.status"
        [uiState]="uiState"
        [autoImmersivePreference]="autoImmersivePreference"
        (configChange)="onConfigChange($event)"
        (statusChange)="onStatusChange($event)"
        (uiStateChange)="onUiStateChange($event)"
        (autoImmersivePreferenceChange)="onAutoImmersivePreferenceChange($event)"
      ></app-automata-control>
    </div>
  </ng-template>

  <div class="mobile-overlay mobile-overlay--rule" *ngIf="isMobileRulePickerOpen" (click)="closeMobileRulePicker()">
    <div class="mobile-overlay__panel mobile-overlay__panel--rule" (click)="$event.stopPropagation()">
      <button
        type="button"
        class="rule-picker__nav"
        aria-label="Previous rule"
        (click)="cycleMobileRulePicker(-1)"
      >
        <lucide-icon name="chevron-up"></lucide-icon>
      </button>
      <div
        class="rule-picker__stack"
        (touchstart)="onRulePickerTouchStart($event)"
        (touchend)="onRulePickerTouchEnd($event)"
        (pointerdown)="onRulePickerTouchStart($event)"
        (pointerup)="onRulePickerTouchEnd($event)"
        (pointercancel)="onRulePickerTouchCancel()"
      >
        <div
          class="rule-picker__item"
          *ngFor="let offset of rulePickerOffsets"
          [class.rule-picker__item--active]="offset === 0"
        >
          {{ getRulePreview(offset)?.label }}
        </div>
        <p class="rule-picker__summary" *ngIf="getRulePreview(0)?.summary">
          {{ getRulePreview(0)?.summary }}
        </p>
      </div>
      <button
        type="button"
        class="rule-picker__nav"
        aria-label="Next rule"
        (click)="cycleMobileRulePicker(1)"
      >
        <lucide-icon name="chevron-down"></lucide-icon>
      </button>
      <button type="button" class="mobile-overlay__close" (click)="closeMobileRulePicker()">Done</button>
    </div>
  </div>

  <div class="mobile-overlay" *ngIf="isMobileColorPickerOpen" (click)="closeMobileColorPicker()">
    <div class="mobile-overlay__panel" (click)="$event.stopPropagation()">
      <p class="mobile-overlay__title">{{ activeColorLabel }}</p>
      <app-color-picker
        [label]="activeColorLabel || ''"
        [color]="activeColorValue"
        (chosenColor)="onMobileColorChosen($event)"
      ></app-color-picker>
      <button type="button" class="mobile-overlay__close" (click)="closeMobileColorPicker()">Done</button>
    </div>
  </div>

  <div class="mobile-overlay" *ngIf="isMobileCellSizeOverlayOpen" (click)="closeMobileCellSizeOverlay()">
    <div class="mobile-overlay__panel" (click)="$event.stopPropagation()">
      <p class="mobile-overlay__title">Cell size</p>
      <div class="mobile-overlay__slider">
        <input
          type="range"
          min="1"
          max="40"
          step="1"
          [value]="simulationConfig.cellSize"
          (input)="onMobileCellSizeInput($event)"
          aria-label="Cell size"
        />
        <span>{{ simulationConfig.cellSize }} px</span>
      </div>
      <button type="button" class="mobile-overlay__close" (click)="closeMobileCellSizeOverlay()">Done</button>
    </div>
  </div>

  <div class="automata-shell__about" *ngIf="isAboutOpen">
    <div class="about-card" role="dialog" aria-modal="true" aria-label="About AutomataJS">
      <button type="button" class="about-card__close" (click)="closeAbout()">
        <lucide-icon name="x"></lucide-icon>
      </button>
      <h3>About AutomataJS</h3>
      <p>
        AutomataJS is a GPU-accelerated playground for iterating on cellular automata without touching GLSL. Every
        simulation runs inside shaders so you can pause, recolor, zoom, and resume at full speed.
      </p>
      <p>
        Responsive controls, touch-friendly sliders, and curated presets help you explore emergent behavior on desktop or
        mobile. Save palettes, tweak rules, and capture high-resolution stills as you experiment.
      </p>
      <a
        class="about-card__link"
        href="https://github.com/bisignam/automatajs"
        target="_blank"
        rel="noopener"
      >
        View project on GitHub
      </a>
    </div>
  </div>
</div>
